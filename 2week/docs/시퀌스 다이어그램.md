# 시퀀스 다이어그램

## 잔액
###  잔액 조회
```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 서비스
    participant 사용자
    participant 잔고
    클라이언트 ->>+ 서비스: 잔액 조회 요청
    서비스 ->>+ 사용자: 사용자 조회
    
    opt 사용자 존재 ❌
        사용자 -->>- 클라이언트: 사용자 미존재 예외 처리
    end
    
    사용자 ->>+ 잔고: 잔고 조회
    잔고 -->>- 서비스: 잔고 값 가져오기
    서비스 -->- 클라이언트:  잔액 조회 완료 ✅
```
1. 서비스에 요청한다.
2. 2~3 사용자 조회 하고 사용자 없으면 오류 보낸다.
3. 4~6 잔고를 조회해서 클라이언트한테 잔액을 제공한다.

###  잔액 충전
```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 서비스
    participant 사용자
    participant 잔고
    participant 잔고이력
    클라이언트 ->>+ 서비스: 잔액 충전 요청
    서비스 ->>+ 사용자: 사용자 조회
    
    opt 사용자 존재 ❌
        사용자 -->>- 클라이언트: 사용자 미존재 오류
        
    end
    사용자 ->>+ 잔고: 잔고 조회 +
    opt 충전 요청 금액이 x원 미만 
        잔고 -->> 클라이언트: 충전 요청 금액이 x원 아상 하라고 요청 보냄
    end
    opt 충전 후 한도가 초과 될때
        잔고 -->> 클라이언트: 충전 요청 금액이 초과 되었다고 오류 보냄
    end
    잔고 ->> 잔고: 잔고 충전 처리
    
    잔고 ->>+ 잔고이력: 충력 이력 저장
    잔고이력 -->>- 잔고: 충력 이력 저장완료
    
    잔고 -->>- 서비스: 충전 완료
    서비스 -->>- 클라이언트: 잔액 충전 요청 완료 ✅

```
1. 서비스에 요청한다.
2. 2~3 사용자 조회 하고 사용자 없으면 오류 보낸다.
3. 4~7 잔고를 조회사 이상 없으면 충전 한다.
4. 8~9: 충전 아력을 저장한다.

## 상품
### 상품 조회
```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 서비스
    participant 상품
    participant 재고
    클라이언트 ->>+ 서비스: 상품 조회 요청
    서비스 ->>+ 상품: 상품 조회
    
    opt 상품 존재 ❌
        상품 -->> 클라이언트: 상품 미존재 예외 처리
    end

    상품 ->>+ 재고: 재고 조회
    재고 -->>- 상품: 재고 조회 완료
    상품 -->>- 서비스: 상품 조회 완료
    서비스 -->- 클라이언트:  상품 조회 요청 완료 ✅(상품과 재고 정보를 제공한다.)
```
1. 서비스에 요청한다.
2. 2~3 상품 조회 하고 상품 없으면 오류 보낸다.
3. 4~5 재고 조회 한다.

## 쿠폰
### 쿠폰 발급
```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 서비스
    participant 사용자
    participant 쿠폰
    participant 사용자 쿠폰
    participant 쿠폰이력
    클라이언트 ->>+ 서비스: 쿠폰 발급 요청
    서비스 ->>+ 사용자: 사용자 조회
    
    opt 사용자 존재 ❌
        사용자 -->> 클라이언트: 사용자 미존재 오류
    end
    사용자 ->>- 서비스: 사용자 조회 완료
    
    서비스 ->>+ 쿠폰: 쿠폰 조회
    opt 쿠폰 존재 ❌
        쿠폰 -->> 클라이언트: 쿠폰 미존재 오류
    end
    opt 쿠팡 수량 부족 ❌
        쿠폰 -->> 클라이언트: 쿠팡 발급 수량 부족 오류 
    end
    쿠폰 ->>+ 사용자 쿠폰: 중복 된 쿠폰 존재 여부 조회
    opt 발급 존재 여부 ⭕️
        사용자 쿠폰 -->>- 클라이언트: 이미 발급 받은 쿠폰 오류
    end
    쿠폰 ->>+ 사용자 쿠폰: 쿠폰 발급
    쿠폰 ->>+ 쿠폰이력: 쿠폰 발급 이력 저장
    쿠폰 -->>- 서비스: 쿠폰 발급 처리 완료
    
    
    서비스 -->>- 클라이언트: 쿠폰 발급 요청 완료 ✅
```
1. 서비스에 요청한다.
2. 2~4 사용자 조회 하고 사용자 없으면 오류 보낸다.
3. 5~9 쿠폰 가능 여부를 체크 한다.
4. 10~13 쿠폰 발급 처리 한다.

### 쿠폰 목록 조회 
```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 서비스
    participant 사용자
    participant 사용자 쿠폰

    클라이언트 ->>+ 서비스: 쿠폰 발급 요청
    서비스 ->>+ 사용자: 사용자 조회

    opt 사용자 존재 ❌
        사용자 -->> 클라이언트: 사용자 미존재 오류
    end
    사용자 ->>- 서비스: 사용자 조회 완료
    
    서비스 ->>+ 사용자 쿠폰: 쿠폰 발급 이력을 조회한다.
    alt 쿠폰 발급 이력 존재 ⭕️
        사용자 쿠폰 -->> 서비스: 발급 이력 목록 제공한다.
    else 쿠폰 발급 이력 존재 ❌
        사용자 쿠폰 -->>- 서비스: 빈 리스트 제공한다.
    end
        
    서비스 -->- 클라이언트:  쿠폰 목록 조회 요청 완료 ✅
```

1. 서비스에 요청한다.
2. 2~4 사용자 조회 하고 사용자 없으면 오류 보낸다.
3. 5~8 쿠폰 목록 조회 처리 한다.

### 주문
```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 서비스
    participant 사용자
    participant 상품
    participant 재고
    participant 쿠폰
    participant 주문
    participant 주문이력
    participant 잔고
    participant 잔고이력
    participant 외부 데이터 플랫품
    
    클라이언트 ->>+ 서비스: 쿠폰 발급 요청
     rect YELLOW
         Note over 서비스, 외부 데이터 플랫품: 주문 처리
         
         서비스 ->>+ 사용자: 사용자 조회

         opt 사용자 존재 ❌
             사용자 -->> 클라이언트: 사용자 미존재 오류
         end
         사용자 ->>- 서비스: 사용자 조회 완료
        loop 상품 목록 조회 🔁
            서비스 ->>+ 상품: 상품 조회
            opt 상품 미존재 ❌
                상품 -->> 클라이언트: 상품 미존재 예외 처리
            end
            상품 -->+ 재고: 상품 재고 조회
            opt 상품 재고 ❌
                재고 -->>- 클라이언트: 상품 없는 재고 예외 처리
            end
            상품 -->>- 서비스: 상품 조회 완료
        end
         서비스 ->>+ 쿠폰: 쿠폰 조회
         opt 쿠폰 존재 ❌
             쿠폰 -->>- 클라이언트: 쿠폰 미존재 오류
         end
        서비스 ->>+ 주문: 주문 처리 시작
        
        주문 ->>+ 쿠폰: 쿠폰 사용
        쿠폰 -->>- 주문: 쿠폰 사용 완료
        주문 ->> 주문: 주문 금액 계산
        주문 ->> 주문: 주문 영수증 생성
        주문 ->> 재고: 주문 재고 차감
        주문 ->>+ 주문이력: 주문 이력 저장
        주문이력 ->> 주문이력: 주문한 각 상품 이력 쌀기
        주문이력 -->>- 주문: 주문 이력 저장 완료 
        alt 주문 금액 == 0 
            주문 ->> 외부 데이터 플랫품: 주문 데이터 전송
        else 주문 금액 > 0
            rect ORANGE
                Note over 주문, 외부 데이터 플랫품: 결제 처리
                주문 ->>+ 잔고: 사용지 잔고 처리
                opt 주문 금액 < 사용자 잔고
                    잔고 -->> 클라이언트: 잔고 부족 오류
                end
                잔고 ->> 잔고: 잔고 금액 차감
                잔고 ->> 잔고이력: 잔고 금액 차감 이력 쌓기
                잔고 ->>- 주문: 잔고 차감 완료
                주문 ->> 외부 데이터 플랫품: 주문 데이터 전송
            end
        end
         주문 -->> 서비스: 주문 처리 끝
     end
        서비스 -->> 클라이언트: 주문 처리 요청 완료 ✅

```
1. 서비스에 요청한다.
2. 2~4 사용자 조회 하고 사용자 없으면 오류 보낸다.
3. 5~9 상품 조회
4. 10~11 쿠폰 조회
5. 12 ~ 28 주문 처리
    - 12 ~ 20 주문 처리 
        - 13 ~ 16 주문서 생성
        - 17 상품 재고 차감
        - 18 ~ 19 주문 이력 쌓기
    - 21 ~ 27: 결제 처리

### 상위 상품 조회 및 스케줄러
```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 서비스
    participant 상품 통계
    participant 상품 주문 이력
   
   rect YELLOW
       Note over 상품 통계, 상품 주문 이력: 스케줄러
       loop 일별 상품 통계
           상품 통계 ->>+ 상품 주문 이력: 하루전 주문한 상품들 조회
           상품 주문 이력 -->>- 상품 통계: 조회 완료
           상품 통계 ->>  상품 통계: 각 상품 집계후 상품 통계 테이블에 저장
       end
   end
   
   클라이언트 ->>+ 서비스: 상위 상품 조회 요청:
    서비스 ->>+ 상품 통계: 주문한 상위 상품 조회
    상품 통계 -->>- 서비스: 주문한 상위 상품 조회 완료
    서비스 -->>- 클라이언트: 상위 상품 조회 요청 완료 ✅
```
1. 1~3 상품 통계처리
2. 4 ~ 7 상위 상품 조회